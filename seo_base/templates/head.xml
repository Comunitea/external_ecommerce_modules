<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <template id="portal_frontend_layout" inherit_id="portal.frontend_layout" name="Main Frontend Layout Seo Base">
        <!-- Set javascript source after the footer -->
        <xpath expr="//div[@id='wrapwrap']/footer" position="inside">
            <t t-call-assets="web.assets_common" t-css="false"/>
            <t t-call-assets="web.assets_frontend" t-css="false"/>
            <t t-call-assets="web_editor.summernote" t-css="false" groups="website.group_website_publisher"/>
            <t t-call-assets="web_editor.assets_editor" t-css="false" groups="website.group_website_publisher"/>
            <t t-call-assets="website.assets_editor" t-css="false" groups="website.group_website_publisher"/>
        </xpath>
    </template>

    <template id="website_layout" inherit_id="website.layout" name="Main Layout Seo Base">
        <!-- Replace javascript source in the head -->
        <xpath expr="//t[@t-call-assets='web.assets_common'][@t-css='false']" position="replace"/>
        <xpath expr="//t[@t-call-assets='web.assets_frontend'][@t-css='false']" position="replace"/>
        <xpath expr="//t[@t-call-assets='web_editor.summernote'][@t-css='false']" position="replace"/>
        <xpath expr="//t[@t-call-assets='web_editor.assets_editor'][@t-css='false']" position="replace"/>
        <xpath expr="//t[@t-call-assets='website.assets_editor'][@t-css='false']" position="replace"/>

         <!-- Add service worker javascript -->
        <xpath expr="//script[@id='tracking_code']" position="before">
            <script type="text/javascript">
                $(document).ready(function(){
                    // Register Service Worker for Progressive Web App
                    if('serviceWorker' in navigator) {
                    <t t-if="website.sw_offline and website.sw_offline == True">
                        navigator.serviceWorker.register('/sw.js').then(function() {
                        <t t-if="website.console_mode and website.console_mode == 'dev'">
                            console.log("Service Worker Registered");
                        </t>
                        });
                    </t>
                    <t t-else="">
                        navigator.serviceWorker.getRegistrations().then(function(registrations) {
                            for(let registration of registrations) {
                                registration.unregister()
                            }
                            <t t-if="website.console_mode and website.console_mode == 'dev'">
                                console.log("Service Worker unregistered");
                            </t>
                            });
                    </t>}
                });
            </script>
        </xpath>

        <!-- Favicon -->
        <xpath expr="//t[@t-set='x_icon']" position="attributes">
            <attribute name="t-value">'/favicon.ico'</attribute>
        </xpath>

        <!-- Metadata -->
        <xpath expr="//meta[last()]" position="after">
            <!-- Set manifest.json link into the head -->
            <meta name="theme-color" t-att-content="website.web_app_theme_color" t-if="website.web_app_theme_color"/>
            <link href="/manifest.json" rel="manifest"/>

             <!-- Add analytics noscript links -->
            <t t-if="website and website.facebook_pixel_key and not editable">
                <!-- Facebook Pixel Code -->
                <script>
                    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
                    n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
                    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
                    n.queue=[];t=b.createElement(e);t.async=!0;
                    t.src=v;s=b.getElementsByTagName(e)[0];
                    s.parentNode.insertBefore(t,s)}(window,document,'script',
                    'https://connect.facebook.net/en_US/fbevents.js');
                    fbq('init', '<t t-esc="website.facebook_pixel_key"/>');
                    fbq('track', 'PageView');
                </script>
                <!-- End Facebook Pixel Code -->
            </t>
        </xpath>
        <xpath expr="//t[@t-set='head_website']" position="after">
            <t t-if="website and website.facebook_pixel_key and not editable">
                <!-- Facebook Pixel Code (noscript) -->
                <noscript>
                    <img height="1" width="1" t-attf-src="https://www.facebook.com/tr?id={{ website.facebook_pixel_key }}&amp;ev=PageView&amp;noscript=1" />
                </noscript>
                <!-- Facebook Pixel Code (noscript) -->
            </t>
        </xpath>

        <!-- Set Product SEO Metadata or default website metadata-->
        <!-- Meta Title -->
        <xpath expr="//t[@t-if='not title']/t[2]" position="replace">
            <t t-if="product and product.product_meta_title and product.product_meta_title != ''">
                <t t-set="title" t-value="product.product_meta_title"/>
            </t>
            <t t-elif="main_object and 'website_meta_title' in main_object and main_object.website_meta_title">
                <t t-set="title" t-value="main_object.website_meta_title"/>
            </t>
        </xpath>
        <!-- Meta Description -->
        <xpath expr="//t[@t-set='meta_description']" position="attributes">
            <attribute name="t-value">
                product.product_meta_description if product and product.product_meta_description and product.product_meta_description != '' else main_object and 'website_meta_keywords' in main_object and main_object.website_meta_keywords or website_meta_keywords
            </attribute>
        </xpath>
        <!-- Meta Keywords -->
        <xpath expr="//t[@t-set='meta_keywords']" position="attributes">
            <attribute name="t-value">
                product.product_meta_keywords if product and product.product_meta_keywords and product.product_meta_keywords != '' else main_object and 'website_meta_keywords' in main_object and main_object.website_meta_keywords or website_meta_keywords
            </attribute>
        </xpath>
    </template>

</odoo>